#!/usr/bin/env bash

set -e

# Get the script's directory (os-config root)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Get current hostname
CURRENT_HOSTNAME="$(hostname)"

# Read hostnames.txt to find the corresponding config directory
HOSTNAMES_FILE="$SCRIPT_DIR/hostnames.txt"

if [ ! -f "$HOSTNAMES_FILE" ]; then
  echo "Error: $HOSTNAMES_FILE not found"
  exit 1
fi

# Find the line matching the current hostname and extract the config directory
CONFIG_DIR=$(grep "^$CURRENT_HOSTNAME " "$HOSTNAMES_FILE" | awk '{print $2}')

if [ -z "$CONFIG_DIR" ]; then
  echo "Error: No configuration found for hostname '$CURRENT_HOSTNAME' in $HOSTNAMES_FILE"
  exit 1
fi

echo "Using configuration for hostname: $CURRENT_HOSTNAME"
echo "Configuration directory: $CONFIG_DIR"

# Build full path to config directory
if [[ "$CONFIG_DIR" = /* ]]; then
  # Absolute path provided
  CONFIG_PATH="$CONFIG_DIR"
else
  # Relative path - resolve from script directory
  CONFIG_PATH="$SCRIPT_DIR/$CONFIG_DIR"
fi

# Validate that the directory exists
if [ ! -d "$CONFIG_PATH" ]; then
  echo "Error: Directory '$CONFIG_PATH' does not exist"
  exit 1
fi

HOME_DIR="/home/nixos"

echo "Deploying to: $HOME_DIR"
echo ""

# Deploy apps
APPS_DIR="$CONFIG_PATH/apps"
if [ -d "$APPS_DIR" ]; then
  echo "=== Deploying Apps ==="
  echo ""

  for app_dir in "$APPS_DIR"/*; do
    if [ ! -d "$app_dir" ]; then
      continue
    fi

    app_name=$(basename "$app_dir")
    target_dir="$HOME_DIR/$app_name"

    echo "--- $app_name ---"

    # Create target directory
    mkdir -p "$target_dir"

    # Sync all files and directories from app directory
    echo "  Syncing files to $target_dir/"
    rsync -a "$app_dir/" "$target_dir/"

    # Start docker compose unless do-not-start-on-apply file exists
    if [ -f "$app_dir/do-not-start-on-apply" ]; then
      echo "  Skipping docker compose start (do-not-start-on-apply file present)"
    else
      echo "  Starting docker compose for $app_name..."
      docker compose -f "$target_dir/compose.yml" up -d
    fi

    echo ""
  done
else
  echo "No apps directory found, skipping apps deployment"
  echo ""
fi

# Deploy jobs
JOBS_DIR="$CONFIG_PATH/jobs"
if [ -d "$JOBS_DIR" ]; then
  echo "=== Deploying Jobs ==="
  echo ""

  for job_dir in "$JOBS_DIR"/*; do
    if [ ! -d "$job_dir" ]; then
      continue
    fi

    job_name=$(basename "$job_dir")
    target_dir="$HOME_DIR/$job_name"

    echo "--- $job_name ---"

    # Create target directory
    mkdir -p "$target_dir"

    # Sync all files and directories from job directory
    echo "  Syncing files to $target_dir/"
    rsync -a "$job_dir/" "$target_dir/"

    echo ""
  done
else
  echo "No jobs directory found, skipping jobs deployment"
  echo ""
fi

echo "Deployment complete!"
