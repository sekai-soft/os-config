#!/usr/bin/env bash

set -euo pipefail

if [ "$(id -u)" -ne 0 ]; then
  echo "ERROR: This script must be run as root."
  exit 1
fi

if [ ! -f /etc/os-release ]; then
  echo "ERROR: /etc/os-release not found. Are you running Ubuntu?"
  exit 1
fi

. /etc/os-release

if [ "${ID:-}" != "ubuntu" ]; then
  echo "ERROR: This script targets Ubuntu. Detected: ${ID:-unknown}"
  exit 1
fi

# Get the script's directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source common config path logic
source "$SCRIPT_DIR/lib-get-config-path"

echo "Installing Docker..."
echo ""

if command -v docker >/dev/null 2>&1; then
  echo "Docker already installed; skipping install."
else
  "$SCRIPT_DIR/os-common-ubuntu-24-root/install-docker"
fi

echo "Installing cronjobs..."
echo ""

install -m 0644 "$CONFIG_PATH/cron" /etc/cron.d/root-cron
if ! command -v cron >/dev/null 2>&1 && ! dpkg -s cron >/dev/null 2>&1; then
  apt-get update
  apt-get install -y cron
fi
systemctl enable --now cron

echo ""
echo "Setup complete."
