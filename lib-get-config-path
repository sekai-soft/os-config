#!/usr/bin/env bash

# This script is meant to be sourced by other scripts
# It sets the CONFIG_PATH variable based on the current hostname

# Ensure SCRIPT_DIR is set by the calling script
if [ -z "$SCRIPT_DIR" ]; then
  echo "Error: SCRIPT_DIR must be set before sourcing this script"
  exit 1
fi

# Get current hostname
CURRENT_HOSTNAME="$(hostname)"

# Read hostnames.txt to find the corresponding config directory
HOSTNAMES_FILE="$SCRIPT_DIR/hostnames.txt"

if [ ! -f "$HOSTNAMES_FILE" ]; then
  echo "Error: $HOSTNAMES_FILE not found"
  exit 1
fi

# Find the line matching the current hostname and extract the config directory
CONFIG_DIR=$(grep "^$CURRENT_HOSTNAME " "$HOSTNAMES_FILE" | awk '{print $2}')

if [ -z "$CONFIG_DIR" ]; then
  echo "Error: No configuration found for hostname '$CURRENT_HOSTNAME' in $HOSTNAMES_FILE"
  exit 1
fi

echo "Using configuration for hostname: $CURRENT_HOSTNAME"
echo "Configuration directory: $CONFIG_DIR"

# Build full path to config directory
if [[ "$CONFIG_DIR" = /* ]]; then
  # Absolute path provided
  CONFIG_PATH="$CONFIG_DIR"
else
  # Relative path - resolve from script directory
  CONFIG_PATH="$SCRIPT_DIR/$CONFIG_DIR"
fi

# Validate that the directory exists
if [ ! -d "$CONFIG_PATH" ]; then
  echo "Error: Directory '$CONFIG_PATH' does not exist"
  exit 1
fi

# Convert to absolute path
CONFIG_PATH="$(cd "$CONFIG_PATH" && pwd)"
