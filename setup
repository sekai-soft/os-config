#!/usr/bin/env bash

set -e

# Get the script's directory (os-config root)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Get current hostname
CURRENT_HOSTNAME="$(hostname)"

# Read hostnames.txt to find the corresponding config directory
HOSTNAMES_FILE="$SCRIPT_DIR/hostnames.txt"

if [ ! -f "$HOSTNAMES_FILE" ]; then
  echo "Error: $HOSTNAMES_FILE not found"
  exit 1
fi

# Find the line matching the current hostname and extract the config directory
CONFIG_FOLDER=$(grep "^$CURRENT_HOSTNAME " "$HOSTNAMES_FILE" | awk '{print $2}')

if [ -z "$CONFIG_FOLDER" ]; then
  echo "Error: No configuration found for hostname '$CURRENT_HOSTNAME' in $HOSTNAMES_FILE"
  exit 1
fi

echo "Using configuration for hostname: $CURRENT_HOSTNAME"

# Build full path to config folder (relative to script directory)
CONFIG_FOLDER="$SCRIPT_DIR/$CONFIG_FOLDER"

# Validate that the directory exists
if [ ! -d "$CONFIG_FOLDER" ]; then
  echo "Error: Directory '$CONFIG_FOLDER' does not exist"
  exit 1
fi

# Convert to absolute path
CONFIG_FOLDER="$(cd "$CONFIG_FOLDER" && pwd)"
echo "Using config folder: $CONFIG_FOLDER"

# Check if configuration.nix exists in the folder
TARGET_CONFIG="$CONFIG_FOLDER/configuration.nix"
if [ ! -f "$TARGET_CONFIG" ]; then
  echo "Error: configuration.nix not found in $CONFIG_FOLDER"
  exit 1
fi

echo "Target configuration: $TARGET_CONFIG"

# Handle /etc/nixos/configuration.nix
NIXOS_CONFIG="/etc/nixos/configuration.nix"
BACKUP_PATH="/etc/nixos/configuration.nix.bak"

# Check if already correctly symlinked (idempotent check)
if [ -L "$NIXOS_CONFIG" ]; then
  CURRENT_TARGET="$(readlink -f "$NIXOS_CONFIG")"
  if [ "$CURRENT_TARGET" = "$TARGET_CONFIG" ]; then
    echo "Setup already complete! Symlink already points to: $TARGET_CONFIG"
    exit 0
  fi
fi

if [ -e "$NIXOS_CONFIG" ]; then
  if [ -L "$NIXOS_CONFIG" ]; then
    # It's a symlink
    echo "Existing symlink detected at $NIXOS_CONFIG"
    LINK_TARGET="$(readlink -f "$NIXOS_CONFIG")"
    echo "Current symlink points to: $LINK_TARGET"
    echo "Backing up symlink target to $BACKUP_PATH"
    echo "$LINK_TARGET" | sudo tee "$BACKUP_PATH" > /dev/null
    sudo rm "$NIXOS_CONFIG"
  elif [ -f "$NIXOS_CONFIG" ]; then
    # It's a regular file
    echo "Existing file detected at $NIXOS_CONFIG"
    echo "Backing up to $BACKUP_PATH"
    sudo cp "$NIXOS_CONFIG" "$BACKUP_PATH"
    sudo rm "$NIXOS_CONFIG"
  fi
fi

# Create symlink
echo "Creating symlink: $NIXOS_CONFIG -> $TARGET_CONFIG"
sudo ln -s "$TARGET_CONFIG" "$NIXOS_CONFIG"

echo "Setup complete!"
echo "Configuration symlinked to: $TARGET_CONFIG"
